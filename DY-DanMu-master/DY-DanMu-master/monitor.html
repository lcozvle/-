<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–—é±¼å¼¹å¹•å®æ—¶ç›‘æ§</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        h1 {
            color: #ff5d23;
            text-align: center;
            margin: 0 0 10px 0;
        }

        .current-room-info {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
            background-color: #fff3e0;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ffe0b2;
        }

        .room-id-highlight {
            color: #ff5d23;
            font-weight: bold;
            font-size: 18px;
            margin: 0 5px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .control-panel {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #rid-input {
            padding: 8px;
            border: 1px solid #90caf9;
            border-radius: 4px;
            width: 120px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #2196f3;
        }

        .btn-primary:hover {
            background-color: #1976d2;
        }

        .btn-success {
            background-color: #4CAF50;
        }

        .btn-success:hover {
            background-color: #388E3C;
        }

        .btn-danger {
            background-color: #f44336;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* å¼¹å¹•åˆ—è¡¨åŒºåŸŸ */
        .danmu-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: #fafafa;
            padding: 0;
            position: relative;
        }

        #danmu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .danmu-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .danmu-item:nth-child(even) {
            background-color: #fff;
        }

        .time {
            color: #999;
            font-size: 12px;
            margin-right: 10px;
            min-width: 65px;
            flex-shrink: 0;
        }

        .user {
            color: #007bff;
            font-weight: bold;
            margin-right: 10px;
            min-width: 80px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .content {
            color: #333;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        /* æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’® */
        #scroll-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(33, 150, 243, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #scroll-btn:hover {
            background-color: #2196f3;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“º æ–—é±¼å¼¹å¹•å®æ—¶ç›‘æ§</h1>

        <div class="current-room-info">
            å½“å‰æ­£åœ¨ç›‘æ§ç›´æ’­é—´: <span id="current-rid-display" class="room-id-highlight">-</span>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-count">-</div>
                <div class="stat-label">å¼¹å¹•æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="status">è¿æ¥ä¸­...</div>
                <div class="stat-label">çŠ¶æ€</div>
            </div>
        </div>

        <div class="control-panel">
            <input type="text" id="rid-input" placeholder="è¾“å…¥æˆ¿é—´å·">
            <button onclick="updateRid()" class="btn btn-primary">åˆ‡æ¢æˆ¿é—´</button>
            <button onclick="exportForAI()" class="btn btn-success">ğŸ“¥ å¯¼å‡º AI åˆ†ææ•°æ®</button>
            <button onclick="shutdownSystem()" class="btn btn-danger">âŒ å…³é—­ç³»ç»Ÿ</button>
        </div>

        <div class="danmu-container" id="danmu-container">
            <ul id="danmu-list">
                <div class="loading">ç­‰å¾…æ•°æ®...</div>
            </ul>
            <button id="scroll-btn" onclick="scrollToBottom()">â¬‡</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let currentRid = '';
        let danmuSet = new Set(); // ç”¨äºå»é‡
        let isAutoScroll = true;  // æ˜¯å¦è‡ªåŠ¨æ»šåŠ¨
        const MAX_ITEMS = 500;    // åˆ—è¡¨æœ€å¤§ä¿ç•™æ•°é‡

        const container = document.getElementById('danmu-container');
        const list = document.getElementById('danmu-list');
        const scrollBtn = document.getElementById('scroll-btn');

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        container.addEventListener('scroll', () => {
            // å¦‚æœè·ç¦»åº•éƒ¨è¶…è¿‡ 50pxï¼Œåˆ™åœæ­¢è‡ªåŠ¨æ»šåŠ¨
            if (container.scrollHeight - container.scrollTop - container.clientHeight > 50) {
                isAutoScroll = false;
                scrollBtn.style.display = 'flex';
            } else {
                isAutoScroll = true;
                scrollBtn.style.display = 'none';
            }
        });

        function scrollToBottom() {
            container.scrollTop = container.scrollHeight;
            isAutoScroll = true;
            scrollBtn.style.display = 'none';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        function generateId(item) {
            return `${item.Payload.cst}-${item.Payload.nn}-${item.Payload.txt}`;
        }

        async function fetchCurrentRid() {
            try {
                const response = await fetch(`${API_BASE}/config/current_rid`);
                const data = await response.json();
                if (data.code === 200 && data.rid) {
                    currentRid = data.rid;
                    document.getElementById('current-rid-display').textContent = currentRid;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/search/Count`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ EndTime: Date.now() })
                });
                const data = await response.json();
                if (data.code === 200) {
                    document.getElementById('total-count').textContent = data.data.Count;
                    document.getElementById('status').textContent = 'è¿è¡Œä¸­ ğŸŸ¢';
                    document.getElementById('status').style.color = 'green';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('status').textContent = 'è¿æ¥å¤±è´¥ ğŸ”´';
                document.getElementById('status').style.color = 'red';
            }
        }

        async function fetchDanmu() {
            try {
                const body = { From: 0 };
                if (currentRid) {
                    body.rid = currentRid;
                }
                // è¯·æ±‚æœ€æ–°çš„ 20 æ¡
                const response = await fetch(`${API_BASE}/search/all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (data.code === 200 && data.data.result_list) {
                    // ç§»é™¤ loading
                    const loading = list.querySelector('.loading');
                    if (loading) loading.remove();

                    // API è¿”å›çš„æ˜¯å€’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åè½¬é¡ºåºï¼ŒæŠŠæ—§çš„å…ˆåŠ è¿›å»ï¼ˆå¦‚æœè¿˜æ²¡åŠ çš„è¯ï¼‰
                    // ä½†å®é™…ä¸Šæˆ‘ä»¬æ˜¯è¿½åŠ åˆ°åº•éƒ¨ï¼Œæ‰€ä»¥åº”è¯¥æŠŠæœ€æ–°çš„åŠ åˆ°åº•éƒ¨ã€‚
                    // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šAPI è¿”å› [æ–°1, æ–°2, æ–°3...]
                    // æˆ‘ä»¬åº”è¯¥æŒ‰ [æ–°3, æ–°2, æ–°1] çš„é¡ºåºè¿½åŠ åˆ°åº•éƒ¨ã€‚
                    const items = data.data.result_list.reverse();

                    let hasNew = false;
                    items.forEach(item => {
                        const id = generateId(item);
                        if (!danmuSet.has(id)) {
                            danmuSet.add(id);
                            hasNew = true;

                            const li = document.createElement('li');
                            li.className = 'danmu-item';
                            li.innerHTML = `
                                <span class="time">${formatTime(item.Payload.cst)}</span>
                                <span class="user">${item.Payload.nn}</span>
                                <span class="content">${item.Payload.txt}</span>
                            `;
                            list.appendChild(li);
                        }
                    });

                    // é™åˆ¶åˆ—è¡¨é•¿åº¦
                    while (list.children.length > MAX_ITEMS) {
                        const first = list.firstElementChild;
                        // å°è¯•ä» Set ä¸­ç§»é™¤ï¼ˆè™½ç„¶å¾ˆéš¾ç²¾ç¡®æ‰¾åˆ°å¯¹åº”çš„ keyï¼Œä½†ä¸ºäº†å†…å­˜ä¸æ³„éœ²ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                        // å®é™…ç”Ÿäº§ä¸­å¯èƒ½éœ€è¦ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—æ¥åŒæ­¥åˆ é™¤ Set
                        list.removeChild(first);
                    }

                    // è‡ªåŠ¨æ»šåŠ¨
                    if (hasNew && isAutoScroll) {
                        scrollToBottom();
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function updateRid() {
            const rid = document.getElementById('rid-input').value;
            if (!rid) {
                alert('è¯·è¾“å…¥ç›´æ’­é—´ ID');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/config/rid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rid: rid })
                });
                const data = await response.json();
                if (data.code === 200) {
                    alert(data.msg);
                    currentRid = rid;
                    document.getElementById('current-rid-display').textContent = currentRid;
                    document.getElementById('rid-input').value = '';

                    // åˆ‡æ¢æˆ¿é—´æ—¶ï¼Œæ¸…ç©ºåˆ—è¡¨
                    list.innerHTML = '<div class="loading">æ­£åœ¨åˆ‡æ¢æˆ¿é—´å¹¶ç­‰å¾…æ–°å¼¹å¹•...</div>';
                    danmuSet.clear();
                    isAutoScroll = true;
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.msg);
                }
            } catch (e) {
                console.error(e);
                alert('è¯·æ±‚å¤±è´¥');
            }
        }

        function exportForAI() {
            let url = `${API_BASE}/export/ai`;
            if (currentRid) {
                url += `?rid=${currentRid}`;
            }
            window.location.href = url;
        }

        async function shutdownSystem() {
            if (!confirm('ç¡®å®šè¦å…³é—­æ‰€æœ‰æœåŠ¡å¹¶é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')) {
                return;
            }
            try {
                await fetch(`${API_BASE}/system/shutdown`, { method: 'POST' });
                alert('ç³»ç»Ÿå·²å‘é€å…³é—­æŒ‡ä»¤ï¼Œé¡µé¢å°†åœæ­¢æ›´æ–°ã€‚');
                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;"><h1>ç³»ç»Ÿå·²å…³é—­</h1><p>æ‚¨å¯ä»¥å…³é—­æ­¤æ ‡ç­¾é¡µäº†ã€‚</p></div>';
            } catch (e) {
                console.error(e);
                alert('å‘é€å…³é—­æŒ‡ä»¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…³é—­çª—å£ã€‚');
            }
        }

        // åˆå§‹åŠ è½½
        fetchCurrentRid().then(() => {
            fetchStats();
            fetchDanmu();
        });

        // å®šæ—¶åˆ·æ–° (æ¯2ç§’ï¼ŒåŠ å¿«ä¸€ç‚¹)
        setInterval(() => {
            fetchStats();
            fetchDanmu();
        }, 2000);
    </script>
</body>

</html>